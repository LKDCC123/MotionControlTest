#include "ChzSD_sdfastdefs.h"
#include "..\\ChzFramePlatformSelector.h"
#define ChzF(a, b, c) for(int a = (b); a <= (c); a++)

namespace ChzSD
{
	void sdjacobian(int body, double point[3], double J[6][ndof])
	{
		static double linchg[3], rotchg[3], linchg_w[3], rotchg_w[3];
		ChzF(i, 0, ndof - 1)
		{
			sdrel2cart(i, body, point, linchg, rotchg);
			sdtrans(body, linchg, -1, linchg_w);
			sdtrans(body, rotchg, -1, rotchg_w);
			ChzF(j, 0, 2) J[j][i] = linchg_w[j], J[j + 3][i] = rotchg_w[j];
		}
	}

	double djacobian_data[2 * ndof][6][ndof];
	void sddjacobian(double q[ndof], double dq[ndof], int body, double point[3], double dJ[6][ndof])
	{
		static double deltaq = 1e-3;
		static double qtemp[ndof];
		ChzF(i, 0, ndof - 1) qtemp[i] = q[i];
		ChzF(i, 0, ndof - 1)
		{
			qtemp[i] = q[i] + deltaq;
			sdstate(0, qtemp, dq);
			sdjacobian(body, point, djacobian_data[2 * i]);
			qtemp[i] = q[i] - deltaq;
			sdstate(0, qtemp, dq);
			sdjacobian(body, point, djacobian_data[2 * i + 1]);
			qtemp[i] = q[i];
		}
		sdstate(0, q, dq);
		ChzF(i, 0, 5) ChzF(j, 0, ndof - 1)
		{
			dJ[i][j] = 0.0;
			ChzF(k, 0, ndof - 1)
			{
				double djdqk = (djacobian_data[2 * k][i][j] - djacobian_data[2 * k + 1][i][j]) / (2.0 * deltaq);
				dJ[i][j] += djdqk * dq[k];
			}
		}
	}

#ifdef CHZFRAME_DEBUG
	const double bodygeoms[nbod][10] =
	{	//	mass     inerx   inery   inerz    bodytojoint           inbtojoint
/*midbody*/	15.733,  0.1760, 0.1149, 0.1099,  0.000, 0.000, 0.000,  0.000, 0.000, 0.000,
/*uppbody*/	12.297,  0.4813, 0.1584, 0.4315,  0.000, 0.000,-0.167,  0.008, 0.000, 0.150,
/*larm*/	01.520,  0.0264, 0.0277, 0.0021,  0.000, 0.000, 0.291,  0.000, 0.268, 0.017,
/*rarm*/	01.520,  0.0264, 0.0277, 0.0021,  0.000, 0.000, 0.291,  0.000,-0.268, 0.017,
/*lthigh*/	06.042,  0.0530, 0.0550, 0.0140,  0.000, 0.000, 0.196,  0.000, 0.080,-0.086,
/*lshank*/	00.719,  0.0121, 0.0124, 0.0005,  0.000, 0.000, 0.132,  0.000, 0.000,-0.124,
/*lfoot*/	01.152,  0.0017, 0.0047, 0.0052,  0.000, 0.000, 0.050,  0.000, 0.000,-0.188,
/*rthigh*/	06.042,  0.0530, 0.0550, 0.0140,  0.000, 0.000, 0.196,  0.000,-0.080,-0.086,
/*rshank*/	00.719,  0.0121, 0.0124, 0.0005,  0.000, 0.000, 0.132,  0.000, 0.000,-0.124,
/*rfoot*/	01.152,  0.0017, 0.0047, 0.0052,  0.000, 0.000, 0.050,  0.000, 0.000,-0.188,
	};
#endif

#ifdef CHZFRAME_BHR7P1_SIM
	const double bodygeoms[nbod][10] =
	{//		mass     inerx   inery   inerz    bodytojoint           inbtojoint
/*midbody*/	15.733,  0.1760, 0.1149, 0.1099,  0.000, 0.000, 0.000,  0.000, 0.000, 0.000,
/*uppbody*/	15.401,  0.4813, 0.1584, 0.4315,  0.000, 0.000,-0.167,  0.008, 0.000, 0.150, // 12.297 + 3.104
/*larm*/		01.520,  0.0264, 0.0277, 0.0021,  0.000, 0.000, 0.291,  0.000, 0.268, 0.017,
/*rarm*/		01.520,  0.0264, 0.0277, 0.0021,  0.000, 0.000, 0.291,  0.000,-0.268, 0.017,
/*lthigh*/	06.042,  0.0530, 0.0550, 0.0140,  0.000, 0.000, 0.196,  0.000, 0.080,-0.086,
/*lshank*/	00.719,  0.0121, 0.0124, 0.0005,  0.000, 0.000, 0.132,  0.000, 0.000,-0.124,
/*lfoot*/	01.152,  0.0017, 0.0047, 0.0052,  0.000, 0.000, 0.050,  0.000, 0.000,-0.188,
/*rthigh*/	06.042,  0.0530, 0.0550, 0.0140,  0.000, 0.000, 0.196,  0.000,-0.080,-0.086,
/*rshank*/	00.719,  0.0121, 0.0124, 0.0005,  0.000, 0.000, 0.132,  0.000, 0.000,-0.124,
/*rfoot*/	01.152,  0.0017, 0.0047, 0.0052,  0.000, 0.000, 0.050,  0.000, 0.000,-0.188,
	};
#endif

#ifdef CHZFRAME_BHR7P1
	const double bodygeoms[nbod][10] =
	{	//	mass     inerx   inery   inerz    bodytojoint           inbtojoint
/*midbody*/	15.733,  0.1760, 0.1149, 0.1099,  0.000, 0.000, 0.000,  0.000, 0.000, 0.000,
/*uppbody*/	15.401,  0.4813, 0.1584, 0.4315,  0.000, 0.000,-0.167,  0.008, 0.000, 0.150,
/*larm*/	01.520,  0.0264, 0.0277, 0.0021,  0.000, 0.000, 0.291,  0.000, 0.268, 0.017,
/*rarm*/	01.520,  0.0264, 0.0277, 0.0021,  0.000, 0.000, 0.291,  0.000,-0.268, 0.017,
/*lthigh*/	06.042,  0.0530, 0.0550, 0.0140,  0.000, 0.000, 0.196,  0.000, 0.080,-0.086,
/*lshank*/	00.719,  0.0121, 0.0124, 0.0005,  0.000, 0.000, 0.132,  0.000, 0.000,-0.124,
/*lfoot*/	01.152,  0.0017, 0.0047, 0.0052,  0.000, 0.000, 0.050,  0.000, 0.000,-0.188,
/*rthigh*/	06.042,  0.0530, 0.0550, 0.0140,  0.000, 0.000, 0.196,  0.000,-0.080,-0.086,
/*rshank*/	00.719,  0.0121, 0.0124, 0.0005,  0.000, 0.000, 0.132,  0.000, 0.000,-0.124,
/*rfoot*/	01.152,  0.0017, 0.0047, 0.0052,  0.000, 0.000, 0.050,  0.000, 0.000,-0.188,
	};
#endif

#ifdef CHZFRAME_BHR7P2
	const double bodygeoms[nbod][10] =
	{//		mass     inerx    inery    inerz          bodytojoint            inbtojoint
/*midbody*/	00.000,  0.0000,  0.0000,  0.0000,   0.000,  0.000,  0.000,   0.000,  0.000,  0.000,
/*uppbody*/	19.500,  0.6100,  0.3800,  0.3000,   0.042,  0.000, -0.296,   0.000,  0.000,  0.000,
/*larm*/	01.500,  0.0430,  0.0440,  0.0023,  -0.019,  0.000,  0.229,   0.000,  0.272,  0.115,
/*rarm*/	01.500,  0.0430,  0.0440,  0.0023,  -0.019,  0.000,  0.229,   0.000, -0.272,  0.115,
/*lthigh*/	05.800,  0.0670,  0.0630,  0.0140,  -0.014, -0.015,  0.101,   0.000,  0.080,  0.000,
/*lshank*/	01.800,  0.0300,  0.0300,  0.0002,   0.000,  0.000,  0.091,  -0.014, -0.015, -0.219,
/*lfoot*/	01.150,  0.0017,  0.0047,  0.0052,   0.000,  0.000,  0.075,   0.000,  0.000, -0.229,
/*rthigh*/	05.800,  0.0670,  0.0630,  0.0140,  -0.014,  0.015,  0.101,   0.000, -0.080,  0.000,
/*rshank*/	01.800,  0.0300,  0.0300,  0.0002,   0.000,  0.000,  0.091,  -0.014,  0.015, -0.219,
/*rfoot*/	01.150,  0.0017,  0.0047,  0.0052,   0.000,  0.000,  0.075,   0.000,  0.000, -0.229,
	};
#endif

#ifdef CHZFRAME_ATHLETE
	const double bodygeoms[nbod][10] =
	{//		mass     inerx   inery   inerz    bodytojoint           inbtojoint
/*midbody*/	00.000,  0.0000, 0.0000, 0.0000,  0.000, 0.000, 0.000,  0.000, 0.000, 0.000,
/*uppbody*/	26.560,  1.3269, 1.0581, 0.5137,  0.030, 0.000,-0.200,  0.000, 0.000, 0.000,
/*larm*/	02.000,  0.0791, 0.0832, 0.0066,  0.000, 0.000, 0.200,  0.000, 0.120, 0.200,
/*rarm*/	02.000,  0.0791, 0.0832, 0.0066,  0.000, 0.000, 0.200,  0.000,-0.120, 0.200,
/*lthigh*/	04.320,  0.0829, 0.0932, 0.0288,  0.000, 0.000, 0.162,  0.000, 0.100, 0.000,
/*lshank*/	03.300,  0.0623, 0.0627, 0.0046,  0.000, 0.000, 0.230,  0.000, 0.000,-0.288,
/*lfoot*/	00.200,  0.0002, 0.0002, 0.0001,  0.000, 0.000, 0.050,  0.000, 0.000,-0.220,
/*lthigh*/	04.320,  0.0829, 0.0932, 0.0288,  0.000, 0.000, 0.162,  0.000,-0.100, 0.000,
/*lshank*/	03.300,  0.0623, 0.0627, 0.0046,  0.000, 0.000, 0.230,  0.000, 0.000,-0.288,
/*lfoot*/	00.200,  0.0002, 0.0002, 0.0001,  0.000, 0.000, 0.050,  0.000, 0.000,-0.220,
	};
#endif

	void sdreset()
	{
		ChzF(i, 0, nbod - 1)
		{
			sdmass(i, bodygeoms[i][0]);
			double iner[3][3] =
			{	bodygeoms[i][1], 0.0, 0.0,
				0.0,  bodygeoms[i][2], 0.0,
				0.0, 0.0, bodygeoms[i][3] };
			sdiner(i, iner);
			sdbtj(i, (double*)&bodygeoms[i][4]);
			sditj(i, (double*)&bodygeoms[i][7]);
		}
		sdinit();
	}

}